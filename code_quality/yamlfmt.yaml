parameters:
  - name: SOURCE_FOLDER
    type: string
    default: '.'

steps:

# Step 1: Try to restore Go from cache
- task: Cache@2
  inputs:
    key: 'go | "$(Agent.OS)" | 1.21.5'
    path: /usr/local/go
  displayName: Cache Go Installation

# Step 2: Install Go manually only if cache was not restored
- script: |
    echo "Cache miss - Downloading and installing Go..."
    wget https://golang.org/dl/go1.21.5.linux-amd64.tar.gz
    sudo tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz
  displayName: Install Go if Cache Miss
  condition: and(succeeded(), ne(variables['Cache.RestoreStatus'], 'Succeeded'))

# Step 3: Set PATH to include Go and verify installation
- script: |
    echo "Set up Go from cache or fresh install"
    echo "##vso[task.setvariable variable=PATH;/usr/local/go/bin:$PATH]"
    export PATH=$PATH:/usr/local/go/bin
    go version
  displayName: Use Cached Go
  condition: succeededOrFailed()
